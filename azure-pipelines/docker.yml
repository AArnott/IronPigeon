steps:
  - task: DotNetCoreCLI@2
    displayName: dotnet publish
    inputs:
      command: publish
      arguments: --no-build -c $(BuildConfiguration) /bl:"$(Build.ArtifactStagingDirectory)/build_logs/publish.binlog"
      workingDirectory: src/IronPigeon.Relay
  - task: DockerInstaller@0
    displayName: Install docker CLI
    inputs:
      dockerVersion: 17.09.0-ce
  - task: Docker@2
    displayName: docker build
    inputs:
      containerRegistry: $(acr)
      command: build
      Dockerfile: src/IronPigeon.Relay/Dockerfile
      buildContext: $(Build.SourcesDirectory)
      tags: $(Build.BuildNumber)
  - task: Docker@2
    displayName: docker push
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      containerRegistry: $(acr)
      command: push
      Dockerfile: src/IronPigeon.Relay/Dockerfile
      buildContext: $(Build.SourcesDirectory)
      tags: |
        latest
        $(Build.BuildNumber)
